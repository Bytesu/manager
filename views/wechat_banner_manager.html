<style>
    /*tr{border: 2px crimson solid;}*/
    tr:active {
        background: lightblue;
        color: white
    }

    /*tr:hover{border: 2px greenyellow solid;}*/

    .td_url {
        WORD-WRAP: break-word;
        width: 500px;
    }
</style><br/>

<div class="container">
    <div class="row">
        <div class="col-xs-12">

            <ol class="breadcrumb">
                <li><a href="/">学院派－管理后台</a></li>
                <li class="active">banner图</li>
            </ol>

            <table id="dataTable" class="display table table-bordered">
                <thead>
                <tr class="text-center">
                    <th class="text-center">拖动</th>
                    <th class="text-center">图片</th>
                    <th class="text-center">图片地址</th>
                    <th class="text-center">链接地址</th>
                    <th class="text-center">操作</th>

                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <p class="masthead-button-links">
                <a class="btn  btn-primary btn-shadow" href="javascript:void(0);" role="button">保存列表</a>
            </p>

            <form>
                选择图片<input type="file" style="width: 100%;" id="img_add_url">
                <input type="hidden" style="width: 100%;" id="img_add_file_url">

                <div id="progressNumber"></div>
                <br>
                链接地址<input type="text" style="width: 100%;" id="link_add_url">
            </form>
            <br>

            <p class="masthead-button-links-add">
                <a class="btn  btn-primary btn-shadow" href="javascript:void(0);" role="button">添加轮播图</a>
            </p>
            <br>
            <br>
            <br>
            <br>
            <br>
            <br><br>
        </div>
    </div>
</div>
<!--<div id="ctner-pager"></div>-->
<script id="trTemp" type="text/x-jquery-tmpl">
    <tr data-img="${img_url}" data-link="${link_url}" data-id="${user_id}" id="td-id-${user_id}">
        <td ondragstart="dragStart(event)"  draggable="true"   id="id-${user_id}" ondragenter="dragEnter(event)" ondragleave="dragLeave(event)" ondrop="drop(event)" ondragover="allowDrop(event)" style="line-height: 35px;">长按这里可拖动</td>
        <td><img src="${img_url}"  width="140" height="140"/></td>
        <td><p style=" WORD-WRAP: break-word;width: 150px;">${img_url}</p></td>
        <td class="td_url" draggable="flase"><p style=" WORD-WRAP: break-word;width: 500px;">${link_url}</p></td>
        <td><a href="#" id="img_del_id" class="btn btn-info btn-xs" user_id="${user_id}">删除</a></td>
    </tr>

</script>

<% include ./script/moment.html  %>
<% include ./script/pager.html  %>
<% include ./script/underscore.html  %>

<script>

    function dragStart(event) {
        event.dataTransfer.setData("Text", "td-" + event.target.id);
        event.dataTransfer.setData("Text", "td-" + event.target.id);
    }

    function dragEnter(event) {
        $(event.target).closest('tr')[0].style.backgroundColor = "#e5eecc";
    }

    function dragLeave(event) {
        $(event.target).closest('tr')[0].style.backgroundColor = "";
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drop(event) {
        event.preventDefault();
        $(event.target).closest('tr')[0].style.backgroundColor = "";
        var data = event.dataTransfer.getData("Text");
        $(event.target).closest('tr').after($('#' + data));
    }


    var Teacher = function () {
        this.statusMap = {
            "0": "未审核",
            "1": "已审核"
        };
        this.statusRecommend = {
            0: '已推荐',
            1: '未推荐'
        };
        this.btnStatus = {
            validate: 'validate',//审核
            unvalidate: 'unvalidate',//推荐
            recommended: 'recommended'//已推荐
        };
        this.tbody = '#dataTable tbody';
        this.$submit = $('.masthead-button-links a');
        this.$add_banner = $('.masthead-button-links-add a');
        this.$img_add_url_ = $('#img_add_url');
        this.$trTemp = $('#trTemp');
        this.page = {from: 0, size: 20};
        this.opt_ = {ele: '#ctner-pager', last: false};
        this.init();
    };

    Teacher.prototype.init = function () {
        var that = this;
//        $(this.tbody).delegate('input[type="button"]','click',function() {
//            that.changeStatsu($(this).attr('user_id'),this);
//        });
        this.initTable();
        //保存
        this.$submit.click(function () {
            var res_s = [];
            $(that.tbody).find('tr').each(function (index, val) {
                res_s.push({img_url: $(this).data('img'), link_url: $(this).data('link')});
                console.log("---")
            });
//            alert(JSON.stringify(res));
            G.request({
                type: 'post',
                url: '/v1/banners',
                data: {
                    banners: res_s
                }
            }, function () {
                alert('保存完成！');
            })
        });
        //添加文件
        this.$img_add_url_.change(function () {

            var img_add_url = document.getElementById('img_add_url').files[0];
            var img_add_url_string = '';

            function uploadProgress(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                    document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
                }
                else {
                    document.getElementById('progressNumber').innerHTML = 'unable to compute';
                }
            }

            function uploadComplete(evt) {
                /* This event is raised when the server send back a response */
//                alert("Done - " + evt.target.responseText );
                console.log(img_add_url_string)
//                if(link_add_url != ""){
//                    res_a.push({img_url:data.url+"/"+ct,link_url:link_add_url,user_id:res1.length})
//                    $(that.tbody).append(that.$trTemp.tmpl(res_a));
//                }else{
//                    alert('链接为空');
//                }
                $('#img_add_file_url').val(img_add_url_string);
            }

            function uploadFailed(evt) {
                alert("There was an error attempting to upload the file." + evt);
            }

            function uploadCanceled(evt) {
                alert("The upload has been canceled by the user or the browser dropped the connection.");
            }

            $.ajax({
                type: "get",
                url: "/v1/oss/new_upload?type=image",
                dataType: "json",
                success: function (data) {
                    console.log(JSON.stringify(data))
                    console.log(data.key);
                    console.log(data.OSSAccessKeyId);
                    console.log(img_add_url.type + "--" + img_add_url.name);
                    var ct = data.key + img_add_url.name;
                    img_add_url_string = data.url + "/" + ct;
                    console.log(ct);
                    var fd = new FormData();
                    fd.append('key', ct);
                    fd.append('Content-Type', img_add_url.type);
                    fd.append('OSSAccessKeyId', data.OSSAccessKeyId);
                    fd.append('policy', data.policy)
                    fd.append('signature', data.signature);
                    fd.append("file", img_add_url);
                    console.log(JSON.stringify(fd))
                    var xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener("progress", uploadProgress, false);
                    xhr.addEventListener("load", uploadComplete, false);
                    xhr.addEventListener("error", uploadFailed, false);
                    xhr.addEventListener("abort", uploadCanceled, false);

                    xhr.open('POST', data.url, true); //MUST BE LAST LINE BEFORE YOU SEND
                    xhr.send(fd);

                }, error: function () {
                    alert("请求出错");
                }
            });
        });

        //添加到数据库
        this.$add_banner.click(function () {
            var res_a = [];
            var img_add_file_url = $("#img_add_file_url").val();
            var link_add_url = $("#link_add_url").val();
            var res1 = [];
            $(that.tbody).find('tr').each(function (index, val) {
                res1.push({img_url: $(this).data('img'), link_url: $(this).data('link')});
            });
            if (img_add_file_url != "" && link_add_url != "") {
                res_a.push({img_url: img_add_file_url, link_url: link_add_url, user_id: res1.length})
                $(that.tbody).append(that.$trTemp.tmpl(res_a));
            } else {
                alert('链接为空');
            }

        });

        //删除

        $(this.tbody).delegate('a[id="img_del_id"]', 'click', function () {
            var this_p = this;
            var res_d = [];
            console.log("img_del_id");
            var user_id = $(this_p).attr('user_id');
            $(that.tbody).find('tr').each(function (index, val) {
                res_d.push({img_url: $(this).data('img'), link_url: $(this).data('link')});
            });
            var gnl = confirm("你真的确定要删除吗?");
            if (gnl == true) {
                for (var i = 0; i < res_d.length; i++) {
                    if (user_id == i) {
//                    alert(res[i].img_url)
                        $("#td-id-" + i).remove();
                    }
                }


                var res_d_s = [];
                $(that.tbody).find('tr').each(function (index, val) {
                    res_d_s.push({img_url: $(this).data('img'), link_url: $(this).data('link')});
                });
                G.request({
                    type: 'post',
                    url: '/v1/banners',
                    data: {
                        banners: res_d_s
                    }
                }, function () {
                    alert('保存完成！');
                })

            }

        });
    };

    Teacher.prototype.renderData = function (data) {
        var that = this;
        data = _.map(data, function (ele, index, list) {
            ele.user_id = index;
            ele.statusName = that.statusMap[ele.status];
            ele.self = JSON.stringify(ele);
            ele.recommend = ele.recommended;
            ele.statusRecommended = ele.recommended == true ? that.statusRecommend['0'] : that.statusRecommend['1'];
            return ele;
        });
        $(this.tbody).html(this.$trTemp.tmpl(data));
        that.opt_ = $.extend(this.page, that.opt_);
//        $.pager(that.opt_,function(data){
//            that.opt_ = $.extend(that.opt_,data);
//            that.initTable(data);
//        });
    };

    Teacher.prototype.initTable = function (page) {
        var that = this;
        G.request({
            url: '/v1/banners'
        }, function (data) {
            console.log("------" + JSON.stringify(data));
            that.renderData(data);
        });
    };
    Teacher.prototype.changeStatsu = function (user_id, this_) {
        var that = this;
        var opt = {
            url: '/v1/teachers/set_verified',
            data: {
                user_id: user_id
            },
            type: 'post'
        };
//        审核通过
        if ($(this_).hasClass(that.btnStatus.validate)) {
            opt.data.status = 1;
        } else if ($(this_).hasClass(that.btnStatus.unvalidate)) {
            opt.data.status = -1;
            var tmp = prompt("审核不通过原因:", "");
            if (tmp.length > 0) {
                opt.data.status = -1;
                opt.data.reason = tmp;
            } else {
                return;
            }
        }
        G.request(opt, function (data) {
            alert('发送成功！');
            $(this_).closest('td').siblings('.status').html(that.statusMap['1']);
            $(this_).closest('td').siblings('.status').html('已审核');
            $(this_).siblings('input').remove();
            $(this_).remove();
        });


//        opt.url = '/v1/teachers/'+user_id+'/recommend';
////        推荐
//        if($(this_).hasClass(that.btnStatus.recommend)){
//            opt.data.recommend = 0;
//            G.request(opt,function(data){
//                $(this_).removeClass(that.btnStatus.recommend).addClass(that.btnStatus.recommended);
//            });
//        }
//        //取消推荐
//        if($(this_).hasClass(that.btnStatus.recommended)){
//            opt.data.recommend = 1;
//            G.request(opt,function(data){
//                $(this_).removeClass(that.btnStatus.recommended).addClass(that.btnStatus.recommend);
//            });
//        }
    };

    $(function () {
        new Teacher();
    });
</script>
